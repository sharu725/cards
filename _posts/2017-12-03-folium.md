---
title: Colocando pontos num mapa com Folium
layout: post
image: "/images/tutorial.png"
date: '2017-12-03 10:00:00'
tags:
- data science
- tutorial
- ciencia de dados
- analise de dados
- python
- folium
- mapas
- openstreetmap
- portugu√™s
- git
- open source
- c√≥digo
- docker
- jupyter
comments: true
---

Vamos supor que voc√™ est√° trabalhando com dados do mundo real. E nesses dados voc√™ tem as latitudes e longitudes de algumas entidades. E ainda mais, voc√™ quer colocar essas entidades num mapa e mostrar isso para as suas coleguinhas. Como fazer?

[![gif de um mapa com cordoes](https://media.giphy.com/media/3ov9kbxzfzV6HtnnwI/giphy.gif)](https://media.giphy.com/media/3ov9kbxzfzV6HtnnwI/giphy.gif)

Bem, voc√™ tem algumas op√ß√µes...

- Colocar manualmente pontos no mapa usando o Google Maps, o que √© at√© okay quando voc√™ tem 2 ou 3 entidades mas quando isso passa de 10 j√° fica meio chato n√©?!
- Usar uma biblioteca/pacote de alguma linguagem de programa√ß√£o que fa√ßa isso. Particularmente minha op√ß√£o favorita üíÉüèª

Existem algumas bibliotecas dispon√≠veis para isso, mas hoje vamos falar da [Folium](https://github.com/python-visualization/folium).

## Folium
O prop√≥sito dessa biblioteca √© unir o poder de manipula√ß√£o de dados que Python possui com a for√ßa de visualiza√ß√£o de mapas da biblioteca JavaScript [Leaflet](https://github.com/Leaflet/Leaflet). A ideia aqui √© tornar ainda mais f√°cil a miss√£o de colocar pontos em um mapa.

## Cad√™ o c√≥digo?
Todo c√≥digo que eu vou mostrar abaixo ta organizadinho [neste diret√≥rio no GitHub](https://github.com/jtemporal/intro-folium), nele tem as instru√ß√µes de prepara√ß√£o do ambiente tanto [com docker](https://github.com/jtemporal/intro-folium#docker-) quanto [sem docker](https://github.com/jtemporal/intro-folium#sem-docker). 

### Instala√ß√£o
Comece preparando o ambiente:

~~~ console
$ git clone https://github.com/jtemporal/intro-folium.git
$ cd intro-folium/
~~~

#### Com docker
Se voc√™ gosta da üê≥ :

~~~ console
$ docker-compose build
~~~

#### Sem docker
Se  n√£o √© f√£ da üê≥:

~~~ console
$ pip install -r requirements.txt
$ pip install jupyter
~~~

### Inciando
Depois disso, ainda no terminal:

Na vers√£o üê≥:
~~~ console
$ docker-compose up jupy
~~~

ou sem docker:
~~~ console
$ jupyter notebook
~~~

Depois de rodar um dos comandos acima, voc√™ ver√° uma mensagem parecida com a seguinte no seu terminal:

![foto do terminal rodando docker](/folium/terminal_print.png)
<center>
<i>Foto do terminal rodando o projeto com docker</i>
</center>

A √∫ltima linha indica o token de acesso, √© s√≥ copi√°-la e colocar no navegador para abrir o jupyter. Deve aparecer algo assim para voc√™:

![foto do navegador rodando jupyter](/folium/jupyter_print.png)
<center>
<i>Foto do navegador rodando o jupyter</i>
</center>

Se voc√™ rodar o notebook `folium_intro.ipynb` inteiro voc√™ vai obter os mesmos resultados que vou mostrar aqui. Al√©m disso, se voc√™ clicar na imagem do mapas que v√£o vir a seguir, voc√™ vai ser levado para a p√°gina desses mesmos mapas o que vai de te deixar intergarir com eles üòâ

### Colocando a m√£o na massa

![anime de garota no codigo](https://media.giphy.com/media/FjGEQSybauJqM/giphy.gif)

Come√ßamos importando as bibliotecas necess√°rias e criando um mapa:
~~~ python
import pandas as pd
import folium

brasil = folium.Map(
    location=[-16.1237611, -59.9219642],    # Coordenadas retiradas do Google Maps
    zoom_start=4
)
~~~

O `folium.Map()` precisa apenas do par√¢metro `location` para criar o seu mapa. Esse par√¢metro recebe um par `latitude`-`longitude` que pode ser uma lista ou uma tupla. Aqui eu passei tamb√©m um valor (4) para o par√¢metro `zoom_start`, o padr√£o desse par√¢mentro √© 10, mas um zoom de 10 n√£o deixa o pa√≠s inteiro na regi√£o do mapa por isso, o novo valor de 4. Ao chamar o mapa, temos:

~~~ python
brasil
~~~

[![mapa do brasil](https://raw.githubusercontent.com/jtemporal/intro-folium/master/mapas_imagens/brasil_clean.png)](/folium/brasil_clean)
<center>
<i>Mapa clic√°vel</i>
</center>

Mas agora eu quero colocar pontos no mapa. Aqui vou usar de exemplo um conjunto de dados com geolocaliza√ß√£o de empresas que apareceram nos reembolsos analisados pela [Opera√ß√£o Serenata de Amor](http://serenatadeamor.org/). No reposit√≥rio `intro-folium` tem uma vers√£o reduzida desse conjunto de dados. Ent√£o vamos come√ßar lendo esses dados e colocando no mapa duas primeiras empresas:

~~~ python
empresas = pd.read_csv('empresas.xz')

empresa1 = empresas.iloc[0]
folium.Marker(
    location=[empresa1['latitude'], empresa1['longitude']],
).add_to(brasil)

empresa2 = empresas.iloc[1]
folium.Marker(
    location=[empresa2['latitude'], empresa2['longitude']],
).add_to(brasil)
~~~

O `folium.Marker()` coloca um "pin" de localiza√ß√£o no mapa. Para isso ocorrer precisamos passar novamente a `location` e ainda indicar a qual mapa adicionar esse pin usando o metodo `add_to()`. Chamando nomavente o mapa, temos:

~~~ python
brasil
~~~

[![mapa do brasil com duas empresas](https://raw.githubusercontent.com/jtemporal/intro-folium/master/mapas_imagens/brasil_some_companies.png)](/folium/brasil_some_companies)
<center>
<i>Mapa clic√°vel</i>
</center>


**Resista** a curiosidade de colocar todos as empresas num mapa. Com as mais de ciquenta mil empresas deste dataset, isso provavelmente ir√° travar o seu computador (travou o meu jupyter). Confie em mim, um mapa com todas as empresas do dataset fica assim:

![mapa do brasil com todas empresas](https://raw.githubusercontent.com/jtemporal/intro-folium/master/mapas_imagens/brasil_all_companies.png)

Sabendo que mostrar a belezinha acima trava o computador, vamos ent√£o selecionar um estado apenas para mostrar:

~~~ python
empresas_pe = empresas[empresas['state'] == 'PE']
~~~

Para melhorar a visualiza√ß√£o eu tamb√©m iniciei um novo mapa, esse tem as coordenadas do estado de Pernambuco (meu estado de origem ‚ù§Ô∏è), veja:

~~~ python
pernambuco = folium.Map(
    location=[-8.3833569, -38.5757127],
    zoom_start=7
)

pernambuco
~~~

[![mapa de Pernambuco](https://raw.githubusercontent.com/jtemporal/intro-folium/master/mapas_imagens/pernambuco_clean.png)](/folium/pernambuco_clean)
<center>
<i>Mapa clic√°vel</i>
</center>

E colocando as empresas no mapa:

~~~ python
for _, empresa in empresas_pe.iterrows():
    folium.Marker(
        location=[empresa['latitude'], empresa['longitude']],
    ).add_to(pernambuco)

pernambuco
~~~

[![mapa de Pernambuco com todas as empresas](https://raw.githubusercontent.com/jtemporal/intro-folium/master/mapas_imagens/pernambuco_all_companies.png)](/folium/pernambuco_all_companies)
<center>
<i>Mapa clic√°vel</i>
</center>

Aqui ja podemos notar uma coisa que vale an√°lise: Apesar de no dataset, apresentarem o estado cadastrado como Pernambuco, encontramos duas empresas que sua latitude e longitude n√£o est√£o dentro do limite do estado ü§î

Puxa, muito legal isso, mas meio sem gra√ßa n√©? Ent√£o vamos dar uma olhada em como colorir um pouco as coisas? 

Vamos come√ßar reduzindo ainda mais nossa quantidade de empresas. Selecionei as 110 empresas de Olinda ‚ù§Ô∏è, e coloquei elas no mapa:

~~~ python
empresas_olinda_pe = empresas[empresas['city'] == 'OLINDA']

olinda = folium.Map(
    location=[-7.9981267, -34.9082027],
    zoom_start=13
)

for _, empresa in empresas_olinda_pe.iterrows():
    folium.Marker(
        location=[empresa['latitude'], empresa['longitude']],
    ).add_to(olinda)

olinda
~~~

[![mapa de Olinda com todas as empresas](https://raw.githubusercontent.com/jtemporal/intro-folium/master/mapas_imagens/olinda_all_companies.png)](/folium/olinda_all_companies)
<center>
<i>Mapa clic√°vel</i>
</center>

Depois escolhi alguns bairros dos 22 bairros com empresas para colorir criando um dicion√°rio que mapeia o nome de um bairro para uma cor:

~~~ python
colors = {
 'AMPARO': 'pink',
 'GUADALUPE': 'blue',
 'CASA CAIADA': 'green',
 'PEIXINHOS': 'orange',
 'RIO DOCE': 'red',
 'BAIRRO NOVO': 'purple',
}

olinda = folium.Map(
    location=[-7.9981267, -34.9082027],
    zoom_start=13
)

for _, empresa in empresas_olinda_pe.iterrows():
    if empresa['neighborhood'] in colors.keys():
        folium.Marker(
            location=[empresa['latitude'], empresa['longitude']],
            icon=folium.Icon(color=colors[empresa['neighborhood']])
        ).add_to(olinda)
~~~

Aqui usamos um novo par√¢metro do `folium.Marker()`, o `icon` que recebe um objeto do tipo `folium.Icon` e assim a colora√ß√£o que queremos. Note que, antes de colocar os pontos no mapa, eu limpo o mapa de Olinda recriando esse objeto e assim, ao inv√©s de colocar os pins coloridos por cima do mapa antigo com os pins azuis. Ainda mais um detalhe, esse tipo de marker (que parece um üìå) segue as cores do bootstrap, ou seja, √© limitado, mas para esse exemplo serve:

~~~ python
olinda
~~~

[![mapa de Olinda com algumas empresas e pins coloridos](https://raw.githubusercontent.com/jtemporal/intro-folium/master/mapas_imagens/olinda_some_colored.png)](/folium/olinda_some_colored)
<center>
<i>Mapa clic√°vel</i>
</center>

### Tr√™s coisinhas a mais

#### Mapas em p√°ginas web
Voc√™ pode salvar seus mapas como p√°ginas HTML usando o comando abaixo, basta identificar o mapa que quer salvar, usar o m√©todo `.save()` e passar um nome do arquivo como como par√¢metro. Todas as p√°ginas de mapas desse post foram geradas assim:

~~~ python
olinda.save('mapas_htmls/olinda_some_colored.html')
~~~

#### Informa√ß√µes extras num mapa
Tamb√©m pode passar informa√ß√µes sobre a entidade que voc√™ est√° colocando no mapa usando o par√¢metro `popup`. Assim ao clicar em um dos pins, um bal√£o mostra alguma informa√ß√£o:

~~~ python
folium.Marker(
    location=[empresa['latitude'], empresa['longitude']],
    popup='sou uma empresa de Olinda',
    icon=folium.Icon(color=colors[empresa['neighborhood']])
).add_to(olinda)
~~~

![foto do popup de um pin](/folium/detalhe_empresa.png)
<center>
<i>Foto do bal√£o de uma empresa ap√≥s o clique</i>
</center>

#### Um arco-iris
Como falei antes, o `folium.Marker()` possui cores limitadas, ent√£o se voc√™ precisar de mais cores, ou se voc√™ precisar colocar cores diferentes daquelas dispon√≠veis, use ou o `folium.CircleMarker()` ou o `folium.PolygonMarker()`. Ambos aceitam hash de cores.

E a√≠, vai fazer uns mapas tamb√©m? üòâ

----
## Curiosidades e dicas

### Mapas (e dados) abertos
A Leaflet, e assim por consequ√™ncia tamb√©m o Folium, usa o [OpenStreetMap](http://www.openstreetmap.org/about) para montar seus mapas. Os mapas da OpenStreetMap s√£o abertos e constru√≠dos por uma comunidade de pessoas interessadas em manter/ajudar o projeto, por exemplo, se voc√™ encontrar algum erro em alguma parte do mapa voc√™ pode enviar corre√ß√µes. Recomendo dar uma olhadinha na [Wiki do OpenStreetMap](http://wiki.openstreetmap.org/) para mais informa√ß√µes.

### `df.iloc[i]`
Forma de visualizar qualquer linha do dataframe como se fosse um print bonito, basta passar como `i` o √≠ndice da linha.

### `df.iterrows()`
√â muito √∫til para percorrer as linhas de um dataframe uma a uma. Esse m√©todo retorna sempre um √≠ndice e a linha correspondente.

## Links
- Um resum√£o de dicas sobre pandas: [Pandas cheatsheet da Lel√™ Portella](http://leportella.com/cheatlist/2017/11/22/pandas-cheat-list.html)
- WebApp pra ajudar a escolher um conjunto de cores: [ColorBrewer2](http://colorbrewer2.org/) (obrigada Geremia üòâ)
- O que fazer quando tem muitos pontos? A dica do Filipe (obrigada üòâ) foi usar [um plugin do folium chamado `MarkerCluster`](https://nbviewer.jupyter.org/github/python-visualization/folium/blob/master/examples/MarkerCluster.ipynb)
